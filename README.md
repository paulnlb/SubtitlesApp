# SubtitlesApp

SubtitlesApp is a full-stack application that uses AI tools to generate and translate subtitles for any video.

## Architecture

The application consists of client and server parts:
- Client: .NET MAUI application
  - `FfmpegAndroidBinding`;
  - `SubtitlesApp.MAUI`;
- Server: multiple ASP.NET Core projects:
  - `SubtitlesServer.BFF`;
  - `SubtitlesServer.IdentityApi;`
  - `SubtitlesServer.WhisperApi`;
  - `SubtitlesServer.TranslationApi`;
  - `SubtitlesServer.Application` and `SubtitlesServer.Infrastructure` (onion architecture).

Also the solution has `SubtitlesApp.Core` project which contains shared domain models and services.

## Tools & libs used
‚ù§Ô∏è Whisper.net - for generating subtitles on the back-end side using OpenAI Whisper models;\
‚ù§Ô∏è LlamaSharp - for consuming Ollama API;\
‚ù§Ô∏è Ollama - for hosting open-source LLMs that are used by TranslationApi to translate batches of subtitles;\
‚ù§Ô∏è YARP - for setting up an API gateway;\
üíî FfmpegKit - for media preprocessing on the client side. It's retired now, so migration to another tool is planned in future;\
‚ù§Ô∏è To improve UX inside the MAUI application, some great libs were used, such as CommunityToolkit, VirtualListView, UraniumUI and [my fork](https://github.com/paulnlb/MauiPageFullScreen) of MauiPageFullScreen.

## SubtitlesApp Client
### Screenshots
Subtitles on the screenshots below are generated by Whisper base model and translated by Gemma 2 9B:

<img src="https://github.com/user-attachments/assets/593a3e8a-6056-4937-90c6-d0e8f5fc2801" width="300"/>
<img src="https://github.com/user-attachments/assets/1a56d1ce-4b50-472f-962b-8e22e73c8d80" width="300"/>

Landscape mode is supported as well:

<img src="https://github.com/user-attachments/assets/ca8b4d85-0f9a-498e-b564-9ae14b6fbe35" width="600"/>


Note: You can always configure **WhisperApi** and **TranslationApi** to use much more capable models for better transcription and translation. See [SubtitlesApp Server](#subtitlesapp-server) section.

### Features
Inside the client app, a user can
- Register or log in to access all the features;
- Play local or remote* videos;
- See transcription of any video.
- Hide or reveal subtitles by swiping the player;
- Translate subtitles;
- Hide or reveal translation for each subtitle by swipe;
- Set languages for subtitles/translations.

*remote videos transcription is buggy for now and will be reimplemented.

Subtitles are shown inside a scrollable list which is automatically synchronized with the current video playback.

To simulate real-time transcription, the client app does the following:
1. Stores the source path of a video.
2. When it's time to transcribe, extracts a portion of the video (60 seconds by default), converts it to audio, then resamples and sends to BE.
3. Receives generated subtitles from the BE and shows them to the user.
4. When the current playback approaches the end of transcription coverage, repeats the step 2 until the entire video is covered by subtitles. 

### Platforms:
 ‚úÖ Android;\
 ‚ùå iOS (to be implemented).

### Action items
- **Improve unit test coverage**;
- Re-design UI;
- Add iOS support;
- Add support for desktop platforms (via native or web client);
- Allow users to manually retry failed translations/transcriptions;
- Add subtitles caching and export to .srt;
- Enable using Whisper models locally without BE.

### Important note about FfmpegAndroidBinding
[FfmpegAndroidBinding](https://github.com/paulnlb/SubtitlesApp/tree/master/Client/FfmpegAndroidBinding) allows to use FfmpegKit API inside the .NET Maui application.

**BUT**, it won't work until you add the following files to the [Jars](https://github.com/paulnlb/SubtitlesApp/tree/master/Client/FfmpegAndroidBinding/Jars) directory:
- [ffmpeg-kit-full-6.0-2.LTS.aar](https://github.com/arthenica/ffmpeg-kit/releases/download/v6.0.LTS/ffmpeg-kit-full-6.0-2.LTS.aar)
- [smart-exception-common-0.2.1.jar](https://github.com/tanersener/smart-exception/releases/download/v0.2.1/smart-exception-common-0.2.1.jar)
- [smart-exception-java-0.2.1.jar](https://github.com/tanersener/smart-exception/releases/download/v0.2.1/smart-exception-java-0.2.1.jar)

After adding these binaries, build the FfmpegAndroidBinding project.

## SubtitlesApp Server

Back-end part is a set of multiple ASP.NET Core web apps. Each of them is responsible for different things:
- **SubtitlesServer.WhisperApi** - API for transcription. Uses OpenAI Whisper under the hood. It can be easily configured to use different Whisper sizes and quantizations.
- **SubtitlesServer.TranslationApi** - forms promts and connects to an Ollama-hosted LLM to provide translations for batches of subtitles, taking into account their common context. As the LLM speed may be a bottleneck, Translation API supports streaming of translated subtitles to the client, one by one. The API can be configured to use any LLM that Ollama supports.
- **SubtitlesServer.IdentityApi** - IdentityServer project, responsible for authentication and authorization accross the APIs;
- **SubtitlesServer.BFF** - reverse proxy which redirects client requests to all of the above.

> Note the difference: while TranslationApi forms prompts, interacts with external API and processes its responses, WhisperApi, in contrast, works with models directly via Whisper.net library. 

### Available OpenAI Whisper models
https://github.com/openai/whisper?tab=readme-ov-file#available-models-and-languages

### Available Ollama LLMs
https://ollama.com/search

### Action items
- Add postprocessing for subtitles (e.g. remove the [BLANK AUDIO] subtitles);
- Improve prompts for better translation;
- Re-design register and login pages.